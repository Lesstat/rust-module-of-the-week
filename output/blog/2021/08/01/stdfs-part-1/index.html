<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="author" content="RMOTW Contributors" />
    <meta name="copyright" content="RMOTW Contributors" />


<meta name="keywords" content="motw, fs, easy, path, Module of the Week, " />

    <title>std::fs (Part 1)  Â· Rust Module of the Week
</title>


    <link href="http://localhost:8999/rss.xml" type="application/rss+xml" rel="alternate" title="Rust Module of the Week - Full RSS Feed" />
    <link href="http://localhost:8999/atom.xml" type="application/atom+xml" rel="alternate" title="Rust Module of the Week - Full Atom Feed" />

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

    <link rel="stylesheet" href="/theme/css/web-min.css?763d6018">
    <link rel="icon" type="image/png" sizes="32x32" href="https://www.rust-lang.org/static/images/favicon-32x32.png">
    <link rel="icon" type="image/svg+xml" href="https://www.rust-lang.org/static/images/favicon.svg">
    <link rel="mask-icon" href="https://www.rust-lang.org/static/images/safari-pinned-tab.svg" color="#000">

  </head>
  <body>
    <header class="site-header">
      <div class="container wrapper">
        <a class="site-title" href="http://localhost:8999/">Rust Module of the Week</a>
      </div>
    </header>

    <div class="page-content">
      <div class="container wrapper">
<div class="post">
  <header class="post-header">
<div class="row post-title">
    <div class="col-xs-12 col-sm-4">
      <span class="small text-muted time-prefix">
        <time pubdate="pubdate" datetime="2021-08-01T09:58:00-04:00">01 AUG 2021</time>
      </span>
    </div>
    <div class="col-xs-12 col-sm-8 text-right custom-xs-text-left">
      <a href="http://localhost:8999/blog/2021/08/01/stdfs-part-1/">std::fs (Part 1)</a>
    </div>
  </div>
    </header>

<div class="well">
    <div class="col-md-3">
    </div>
    <div class="col-md-6">
    <h6>This post is part 1 of the "std::fs" series</h6>
    </div>
    <div class="col-md-3">
    </div>
</div>

  <article class="post-content">
    <p>Hello and welcome to <em>Module of the Week</em>. Inspired by <a href="https://pymotw.com/3/">PyMOTW</a> (and similar ideas), this blog series is meant to dig into some modules available when working with Rust. This will primarily cover the <a href="https://doc.rust-lang.org/std/index.html#modules">Standard Library</a> but you'll probably see some popular Crates show up once in a while as well.</p>
<p>Each issue has a bit of a story (not to the length you'd find on some Recipe sites) to guide new users and make learning a bit more fun.</p>
<p>Enough said, let's get to <code>std::fs</code>!</p>
<!-- more -->

<h1>The story</h1>
<p><a href="https://www.fantasynamegenerators.com/dnd-orc-names.php">Rudgal The Delirious</a> is the local Ornithologist. Armed with his trusty camera he's been tasked by the local Government to catalog and identify all of the birds in his local area. As he has to identify not only the species but the individual birds he's ended up with quite a few photos!</p>
<p>Having coded in college (he didn't end up with the title <em>The Delirious</em> for nothing), he sits down with his favorite IDE, forgets about tabs and spaces and dives right into <code>std::fs</code>.</p>
<h1>The module</h1>
<p><a href="https://doc.rust-lang.org/std/fs/index.html">std::fs</a> is the standard Rust module for interacting with a Filesystem. It handles a lot of the messy work when it comes to all the different ways that the underlying OS likes to handle files. Creating, Reading, Updating, Deleting, it's all there! Not every operation is supported by every OS, but this guide will try to remain as platform agnostic as possible. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is a lot of overlap with <a href="https://doc.rust-lang.org/std/path/index.html">std::path</a> in all things filesystem related, but that will be the next module discussed.</p>
</div>
<p>Rudgal keeps all of his files in <code>/home/rudgal/birds</code>, so he'll start with that.</p>
<div class="highlight"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">PHOTO_HOME</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&quot;/home/rudgal/birds&quot;</span><span class="p">;</span><span class="w"></span>
</code></pre></div>

<h2>Listing all of the files in a directory</h2>
<p>As an easy start, Rudgal wants to list all of the photos he's taken. Browsing through the documents, he comes across <a href="https://doc.rust-lang.org/std/fs/fn.read_dir.html">std::fs::read_dir</a>.</p>
<blockquote>
<p>"Aha! An Iterator. A most important tool in Ornithology!" </p>
</blockquote>
<p>Rudgal shouts, to no one in particular.</p>
<p><code>std::fs::read_dir</code> gives you an Iterator (aptly named <a href="https://doc.rust-lang.org/std/fs/struct.ReadDir.html">ReadDir</a>) of <a href="https://doc.rust-lang.org/std/fs/struct.DirEntry.html">DirEntry</a> objects. More specifically it's a <a href="https://doc.rust-lang.org/std/io/type.Result.html">io::Result</a> of <code>DirEntry</code>, in case something goes wrong along the way.</p>
<blockquote>
<p>"I'll start with the paths of the files."</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="p">{</span><span class="n">fs</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">};</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span>::<span class="n">read_dir</span><span class="p">(</span><span class="n">PHOTO_HOME</span><span class="p">)</span><span class="o">?</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">entry_res</span><span class="o">|</span><span class="w"> </span><span class="n">entry_res</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">entry</span><span class="o">|</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">path</span><span class="p">()))</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">io</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="p">()</span><span class="o">?</span><span class="p">;</span><span class="w"></span>

<span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">entries</span><span class="p">);</span><span class="w"></span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you're not familiar with the <code>?</code> syntax or <code>Result</code>s in general, stay tuned for when we dive into the <a href="https://doc.rust-lang.org/std/result/index.html">std::result</a> module!</p>
</div>
<p>After running his program, he gets the following output:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="s2">&quot;/home/rudgal/birds/winter2010&quot;</span>,<span class="s2">&quot;/home/rudgal/birds/savalirwood&quot;</span>, <span class="s2">&quot;/home/rudgal/birds/DCIM_0001.jpg&quot;</span>, <span class="s2">&quot;/home/rudgal/birds/DCIM_0002.jpg&quot;</span>, ... <span class="s2">&quot;/home/rudgal/birds/DCIM_9999.jpg&quot;</span><span class="o">]</span>
</code></pre></div>

<p>Now he has a list of everything in the <code>PHOTO_HOME</code> directory. This includes both files and sub-directories.</p>
<h2>Filtering files in a directory</h2>
<p>Rudgal wants to sort out some of the entries from the previous section. Specifically he just wants to count the photos in the root of <code>PHOTO_HOME</code>. For that he finds his way to <a href="https://doc.rust-lang.org/std/fs/fn.metadata.html">std::fs::metadata</a> in the docs.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// See previous section for the definition of &quot;entries&quot;</span>

<span class="kd">let</span><span class="w"> </span><span class="n">just_photos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entries</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">entry</span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">fs</span>::<span class="n">metadata</span><span class="p">(</span><span class="n">entry</span><span class="p">)))</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Only select files, filtering out any directories or errors</span>
<span class="w">    </span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="n">as_ref</span><span class="p">().</span><span class="n">map_or</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">meta</span><span class="o">|</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="n">is_file</span><span class="p">()))</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Unwrap the results</span>
<span class="w">    </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()))</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">();</span><span class="w"></span>

<span class="fm">println!</span><span class="p">(</span><span class="s">&quot;There are {} actual files.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">just_photos</span><span class="p">.</span><span class="n">len</span><span class="p">());</span><span class="w"></span>
</code></pre></div>

<p>Satisfied with his <code>Vec</code> of <code>(path, metadata)</code> pairs, Rudgal gave it a spin.</p>
<div class="highlight"><pre><span></span><code>There are <span class="m">9999</span> actual files.
</code></pre></div>

<blockquote>
<p>"A perfectly sized collection of fauna!"</p>
</blockquote>
<h2>Getting the size of a file</h2>
<p>Now that he had a list of just the photos in <code>PHOTO_HOME</code>, Rudgal wanted to know how much space all of the files were taking up. Luckily, <a href="https://doc.rust-lang.org/std/fs/struct.Metadata.html">std::fs::Metadata</a> had something for just such an occasion!</p>
<div class="highlight"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">photo_size</span>:<span class="kt">u64</span> <span class="o">=</span><span class="w"> </span><span class="n">just_photos</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="n">len</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">sum</span><span class="p">();</span><span class="w"></span>

<span class="fm">println!</span><span class="p">(</span><span class="s">&quot;Total size is {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">photo_size</span><span class="p">);</span><span class="w"></span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>Total size is <span class="m">127190000</span>
</code></pre></div>

<blockquote>
<p>"Maybe I should organize some of this."</p>
</blockquote>
<p>Back to the docs, Rudgal!</p>
<h2>Recursively get files in a directory</h2>
<p>Rudgal quickly realized he had a problem. By filtering for just files from his original list, he's left out a number of directories left over from some previous half-hearted attempts to organize his photos.</p>
<blockquote>
<p>"Recursion! The cause of, and solution to, all of life's problems!"</p>
</blockquote>
<p>Said Rudgal the Delirious.</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">path</span>::<span class="n">PathBuf</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">visit_dirs</span><span class="p">(</span><span class="n">dir</span>: <span class="kp">&amp;</span><span class="nc">PathBuf</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">PathBuf</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">dir</span><span class="p">.</span><span class="n">is_dir</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">dir_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">fs</span>::<span class="n">read_dir</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">path</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">path</span><span class="p">.</span><span class="n">is_dir</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">files</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">visit_dirs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">)</span><span class="o">?</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">dir_files</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">path</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">files</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">dir_files</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">files</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">flatten</span><span class="p">().</span><span class="n">collect</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="o">..</span><span class="p">.</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">all_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">visit_dirs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PathBuf</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="fm">println!</span><span class="p">(</span><span class="s">&quot;The number of files (recursively) is {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">all_files</span><span class="p">.</span><span class="n">len</span><span class="p">());</span><span class="w"></span>
</code></pre></div>

<p>It's directories all the way down! Let's see what Rudgal got as a result.</p>
<div class="highlight"><pre><span></span><code>The number of files <span class="o">(</span>recursively<span class="o">)</span> is <span class="m">24038</span>
</code></pre></div>

<p>Much better! Now he can be sure he didn't miss any files. He's a bit of a shutterbug.</p>
<h1>Next week</h1>
<p>Stay tuned for next week when we'll continue exploring <code>std::fs</code>, more specifically focusing on creating directories and moving files around.</p>
  </article>

<div class="well">
    <div class="col-md-3">
    </div>
    <div class="col-md-6">
    <h6>This post is part 1 of the "std::fs" series</h6>
    </div>
    <div class="col-md-3">
    </div>
</div>

</div>
      </div>
    </div>

    <footer>
      <div class="container wrapper">
        <div class="row">
          <div class="col-sm-6 col-xs-12">
            <ul class="list-unstyled">
              <li><a href="http://localhost:8999/blog/archives/index.html">past issues</a></li>
              <li><a href="http://localhost:8999/atom.xml">atom feed</a></li>
              <li><a href="http://localhost:8999/rss.xml">rss feed</a></li>
              <li><a href="https://github.com/slyons/rust-module-of-the-week">source code</a></li>
            </ul>
          </div>
          <div class="col-sm-6 col-xs-12 text-right custom-xs-text-left">
            <ul class="list-unstyled">
              <li><a href="http://localhost:8999/pages/privacy-policy.html">privacy policy</a></li>
              <li><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">cc-by-sa-4.0</a></li>
            </ul>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>